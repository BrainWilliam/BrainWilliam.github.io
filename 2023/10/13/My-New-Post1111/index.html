<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>My New Post1111 | Hexo</title>
  <meta name="keywords" content="">
  <meta name="description" content="My New Post1111 | Hexo">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="description" content="èƒŒæ™¯åœ¨æœåŠ¡ç«¯å¼€å‘ä¸­æˆ‘ä»¬ç»å¸¸ä¼šåœ¨ä¸€ä¸ªæœåŠ¡ä¸­å‘èµ·è¯·æ±‚è°ƒç”¨å…¶ä»–æœåŠ¡ã€‚å¾ˆå¤šæœåŠ¡ä¸»è¦é€»è¾‘å°±æ˜¯æ ¹æ®äº§å“é€»è¾‘è°ƒç”¨å„ä¸ªrpcè¯·æ±‚ï¼Œå†æŠŠå„ä¸ªè¯·æ±‚çš„ç»“æœç»„åˆåœ¨ä¸€èµ·è¿”å›ã€‚ä¸šå†…æŠŠä¸“æ³¨äºå¼€å‘è¿™ç±»æœåŠ¡çš„å¼€å‘è€…ç§°ä¸ºAPI Boyã€‚è¿™ç±»æœåŠ¡çš„ç‰¹ç‚¹æ˜¯ioå¯†é›†ï¼Œè€—æ—¶ä¸»è¦æ˜¯rpcè¯·æ±‚ã€‚æ‰€ä»¥ä¼˜åŒ–è¿™ç±»æœåŠ¡çš„è€—æ—¶å°±æ˜¯ä¼˜åŒ–rpcè¯·æ±‚çš„ä¸²å¹¶è¡Œå…³ç³»ã€‚é‚£ä¹ˆæ€æ ·çš„ä¸²å¹¶è¡Œå…³ç³»æ‰æ˜¯æœ€ä¼˜çš„å‘¢ï¼Ÿå…¶å®å¾ˆç®€å•ï¼Œåªè¦åšåˆ°ä¸‹é¢ä¸¤ç‚¹å°±å¯ä»¥äº†ã€‚ æ‰€æœ‰é€»è¾‘éƒ½åœ¨ä¾èµ–æ•°æ®å‡†å¤‡">
<meta property="og:type" content="article">
<meta property="og:title" content="My New Post1111">
<meta property="og:url" content="http://example.com/2023/10/13/My-New-Post1111/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="èƒŒæ™¯åœ¨æœåŠ¡ç«¯å¼€å‘ä¸­æˆ‘ä»¬ç»å¸¸ä¼šåœ¨ä¸€ä¸ªæœåŠ¡ä¸­å‘èµ·è¯·æ±‚è°ƒç”¨å…¶ä»–æœåŠ¡ã€‚å¾ˆå¤šæœåŠ¡ä¸»è¦é€»è¾‘å°±æ˜¯æ ¹æ®äº§å“é€»è¾‘è°ƒç”¨å„ä¸ªrpcè¯·æ±‚ï¼Œå†æŠŠå„ä¸ªè¯·æ±‚çš„ç»“æœç»„åˆåœ¨ä¸€èµ·è¿”å›ã€‚ä¸šå†…æŠŠä¸“æ³¨äºå¼€å‘è¿™ç±»æœåŠ¡çš„å¼€å‘è€…ç§°ä¸ºAPI Boyã€‚è¿™ç±»æœåŠ¡çš„ç‰¹ç‚¹æ˜¯ioå¯†é›†ï¼Œè€—æ—¶ä¸»è¦æ˜¯rpcè¯·æ±‚ã€‚æ‰€ä»¥ä¼˜åŒ–è¿™ç±»æœåŠ¡çš„è€—æ—¶å°±æ˜¯ä¼˜åŒ–rpcè¯·æ±‚çš„ä¸²å¹¶è¡Œå…³ç³»ã€‚é‚£ä¹ˆæ€æ ·çš„ä¸²å¹¶è¡Œå…³ç³»æ‰æ˜¯æœ€ä¼˜çš„å‘¢ï¼Ÿå…¶å®å¾ˆç®€å•ï¼Œåªè¦åšåˆ°ä¸‹é¢ä¸¤ç‚¹å°±å¯ä»¥äº†ã€‚ æ‰€æœ‰é€»è¾‘éƒ½åœ¨ä¾èµ–æ•°æ®å‡†å¤‡">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2023-10-13T09:21:37.000Z">
<meta property="article:modified_time" content="2023-10-13T09:23:27.129Z">
<meta property="article:author" content="å¤©æ™¨">
<meta name="twitter:card" content="summary">


<link rel="icon" href="/img/avatar.jpg">

<link href="/css/style.css?v=1.1.0" rel="stylesheet">

<link href="/css/hl_theme/atom-light.css?v=1.1.0" rel="stylesheet">

<link href="//cdn.jsdelivr.net/npm/animate.css@4.1.0/animate.min.css" rel="stylesheet">

<script src="//cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
<script src="/js/titleTip.js?v=1.1.0" ></script>

<script src="//cdn.jsdelivr.net/npm/highlightjs@9.16.2/highlight.pack.min.js"></script>
<script>
    hljs.initHighlightingOnLoad();
</script>

<script src="//cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js"></script>



<script src="//cdn.jsdelivr.net/npm/jquery.cookie@1.4.1/jquery.cookie.min.js" ></script>

<script src="/js/iconfont.js?v=1.1.0" ></script>

<meta name="generator" content="Hexo 6.3.0"></head>
<div style="display: none">
  <input class="theme_disqus_on" value="false">
  <input class="theme_preload_comment" value="">
  <input class="theme_blog_path" value="">
  <input id="theme_shortcut" value="true" />
  <input id="theme_highlight_on" value="true" />
  <input id="theme_code_copy" value="true" />
</div>



<body>
<aside class="nav">
    <div class="nav-left">
        <a href="/"
   class="avatar_target">
    <img class="avatar"
         src="/img/avatar.jpg"/>
</a>
<div class="author">
    <span>å¤©æ™¨</span>
</div>

<div class="icon">
    
        
            <a title="rss"
               href="/atom.xml"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-rss"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="github"
               href="https://github.com/yelog"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-github"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="facebook"
               href="https://www.facebook.com/faker.tops"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-facebook"></use>
                    </svg>
                
            </a>
        
    
        
    
        
    
        
            <a title="instagram"
               href="https://www.facebook.com/faker.tops"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-instagram"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="reddit"
               href="https://www.reddit.com/user/yelog/"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-reddit"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="weibo"
               href="http://weibo.com/u/2307534817"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-weibo"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="jianshu"
               href="https://www.jianshu.com/u/ff56736de7cf"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-jianshu"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="zhihu"
               href="https://www.zhihu.com/people/jaytp/activities"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-zhihu"></use>
                    </svg>
                
            </a>
        
    
        
    
        
            <a title="oschina"
               href="https://my.oschina.net/yelog"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-oschina"></use>
                    </svg>
                
            </a>
        
    
        
    
        
            <a title="email"
               href="mailto:jaytp@qq.com"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-email"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="qq"
               href="http://wpa.qq.com/msgrd?v=3&uin=872336115&site=qq&menu=yes"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-qq"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="kugou"
               href="https://www.kugou.com/"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-kugou"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="neteasemusic"
               href="https://music.163.com/#/user/home?id=88151013"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-neteasemusic"></use>
                    </svg>
                
            </a>
        
    
</div>





<ul>
    <li>
        <div class="all active" data-rel="All">All
            
                <small>(2)</small>
            
        </div>
    </li>
    
</ul>
<div class="left-bottom">
    <div class="menus">
        
            
            
            
    </div>
    <div>
        
            <a class="about  hasFriend  site_url"
               
               href="/about">About</a>
        
        <a style="width: 50%"
                
                                           class="friends">Friends</a>
        
    </div>
</div>
<input type="hidden" id="yelog_site_posts_number" value="2">

<div style="display: none">
    <span id="busuanzi_value_site_uv"></span>
    <span id="busuanzi_value_site_pv"></span>
</div>

    </div>
    <div class="nav-right">
        <div class="friends-area">
    <div class="friends-title">
        Links
        <i class="iconfont icon-left"></i>
    </div>
    <div class="friends-content">
        <ul>
            
            <li><a target="_blank" href="http://yelog.org/">å¶è½é˜</a></li>
            
        </ul>
    </div>
</div>
        <div class="title-list">
    <div class="right-top">
        <div id="default-panel">
            <i class="iconfont icon-search" data-title="æœç´¢ å¿«æ·é”® i"></i>
            <div class="right-title">All</div>
            <i class="iconfont icon-file-tree" data-title="åˆ‡æ¢åˆ°å¤§çº²è§†å›¾ å¿«æ·é”® w"></i>
        </div>
        <div id="search-panel">
            <i class="iconfont icon-left" data-title="è¿”å›"></i>
            <input id="local-search-input" autocomplete="off"/>
            <label class="border-line" for="input"></label>
            <i class="iconfont icon-case-sensitive" data-title="å¤§å°å†™æ•æ„Ÿ"></i>
            <i class="iconfont icon-tag" data-title="æ ‡ç­¾"></i>
        </div>
        <div id="outline-panel" style="display: none">
            <div class="right-title">å¤§çº²</div>
            <i class="iconfont icon-list" data-title="åˆ‡æ¢åˆ°æ–‡ç« åˆ—è¡¨"></i>
        </div>
    </div>

    <div class="tags-list">
    <input id="tag-search" />
    <div class="tag-wrapper">
        
    </div>

</div>

    
    <nav id="title-list-nav">
        
        
        <a  class="All "
           href="/2023/10/13/My-New-Post1111/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="My New Post1111">My New Post1111</span>
            <span class="post-date" title="2023-10-13 17:21:37">2023/10/13</span>
        </a>
        
        
        <a  class="All "
           href="/2023/10/13/hello-world/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="Hello World">Hello World</span>
            <span class="post-date" title="2023-10-13 17:10:58">2023/10/13</span>
        </a>
        
        <div id="no-item-tips">

        </div>
    </nav>
    <div id="outline-list">
    </div>
</div>

    </div>
    <div class="hide-list">
        <div class="semicircle" data-title="åˆ‡æ¢å…¨å± å¿«æ·é”® s">
            <div class="brackets first"><</div>
            <div class="brackets">&gt;</div>
        </div>
    </div>
</aside>
<div id="post">
    <div class="pjax">
        <article id="post-My-New-Post1111" class="article article-type-post" itemscope itemprop="blogPost">
    
        <h1 class="article-title">My New Post1111</h1>
    
    <div class="article-meta">
        
        
        
        
    </div>
    <div class="article-meta">
        
            Created At : <time class="date" title='Updated At: 2023-10-13 17:23:27'>2023-10-13 17:21</time>
        
    </div>
    <div class="article-meta">
        
        
        <span id="busuanzi_container_page_pv">
            Views ğŸ‘€ :<span id="busuanzi_value_page_pv">
                <span class="count-comment">
                    <span class="spinner">
                      <div class="cube1"></div>
                      <div class="cube2"></div>
                    </span>
                </span>
            </span>
        </span>
        
        
    </div>
    
    <div class="toc-ref">
    
        
    
<style>
    .left-col .switch-btn,
    .left-col .switch-area {
        display: none;
    }
    .toc-level-3 i,
    .toc-level-3 ol {
        display: none !important;
    }
</style>
</div>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>èƒŒæ™¯<br>åœ¨æœåŠ¡ç«¯å¼€å‘ä¸­æˆ‘ä»¬ç»å¸¸ä¼šåœ¨ä¸€ä¸ªæœåŠ¡ä¸­å‘èµ·è¯·æ±‚è°ƒç”¨å…¶ä»–æœåŠ¡ã€‚å¾ˆå¤šæœåŠ¡ä¸»è¦é€»è¾‘å°±æ˜¯æ ¹æ®äº§å“é€»è¾‘è°ƒç”¨å„ä¸ªrpcè¯·æ±‚ï¼Œå†æŠŠå„ä¸ªè¯·æ±‚çš„ç»“æœç»„åˆåœ¨ä¸€èµ·è¿”å›ã€‚ä¸šå†…æŠŠä¸“æ³¨äºå¼€å‘è¿™ç±»æœåŠ¡çš„å¼€å‘è€…ç§°ä¸ºAPI Boyã€‚è¿™ç±»æœåŠ¡çš„ç‰¹ç‚¹æ˜¯ioå¯†é›†ï¼Œè€—æ—¶ä¸»è¦æ˜¯rpcè¯·æ±‚ã€‚æ‰€ä»¥ä¼˜åŒ–è¿™ç±»æœåŠ¡çš„è€—æ—¶å°±æ˜¯ä¼˜åŒ–rpcè¯·æ±‚çš„ä¸²å¹¶è¡Œå…³ç³»ã€‚é‚£ä¹ˆæ€æ ·çš„ä¸²å¹¶è¡Œå…³ç³»æ‰æ˜¯æœ€ä¼˜çš„å‘¢ï¼Ÿå…¶å®å¾ˆç®€å•ï¼Œåªè¦åšåˆ°ä¸‹é¢ä¸¤ç‚¹å°±å¯ä»¥äº†ã€‚</p>
<p>æ‰€æœ‰é€»è¾‘éƒ½åœ¨ä¾èµ–æ•°æ®å‡†å¤‡å¥½çš„ç¬¬ä¸€æ—¶é—´å¼€å§‹è·‘ï¼Œæ¯ä¸ªrpcè¯·æ±‚éƒ½åœ¨è¯·æ±‚æ•°æ®å‡†å¤‡å¥½çš„ç¬¬ä¸€æ—¶é—´å‘èµ·ã€‚<br>ç›¸åŒçš„æ•°æ®åªè¯·æ±‚ä¸€æ¬¡ã€‚<br>äºæ˜¯æˆ‘ä»¬å°±æŠŠä¸€ä¸ªå…¨å±€çš„é—®é¢˜åˆ†è§£æˆå„ä¸ªå±€éƒ¨çš„é—®é¢˜ï¼Œå°±å¯ä»¥åˆ†è€Œæ²»ä¹‹ï¼Œé€ä¸ªå‡»ç ´ã€‚æœ¬æ–‡ä¸»è¦è®¨è®ºå¦‚ä½•åœ¨Goè¯­è¨€å¼€å‘çš„æœåŠ¡ä¸­ç®¡ç†rpcè°ƒç”¨ï¼Œå®ç°ä¸Šè¿°ä¸¤ç‚¹ã€‚</p>
<p>ä¸‹é¢æˆ‘ä»¬å…ˆè®¨è®ºå‡ ç§æƒ…å†µã€‚</p>
<p>æƒ…å†µ1 å¤šä¸ªç›¸åŒæ•°æ®çš„è°ƒç”¨åˆå¹¶ä¸ºä¸€ä¸ª<br>func func1() {<br>    resp :&#x3D; RPC()<br>    handle1(resp)<br>}</p>
<p>func func2() {<br>    resp :&#x3D; RPC()<br>    handle2(resp)<br>}</p>
<p>func Case1() {<br>    go func1()<br>    go func2()<br>}<br>func1ä¸func2åˆ†åˆ«è°ƒç”¨åŒä¸€ä¸ªrpcè·å¾—åŒä¸€ä¸ªç»“æœï¼Œç„¶ååˆ†åˆ«å¯¹ç»“æœåšå¤„ç†ã€‚è¿™é‡Œfunc1ä¸func2åº”è¯¥åˆå¹¶è°ƒç”¨ä¸€æ¬¡rpcï¼Œå‡å°‘ä¸‹æ¸¸çš„å‹åŠ›ã€‚ä¸€ä¸ªé—®é¢˜æ˜¯è¿™é‡Œå¹¶ä¸ç¡®å®šfunc1ä¸func2è°ä¼šå…ˆå‘èµ·rpcï¼Œè§£å†³æ–¹æ³•æ˜¯ä½¿ç”¨sync.Onceã€‚</p>
<p>æƒ…å†µ2 ä¸€ä¸ªåç¨‹ç”Ÿäº§ï¼Œä¸€ä¸ªåç¨‹æ¶ˆè´¹<br>func func1(resp *Resp) {<br>    resp &#x3D; RPC()<br>}</p>
<p>func func2(resp *Resp) {<br>    handle(resp)<br>}</p>
<p>func Case2() {<br>    var resp Resp<br>    go func1(&amp;resp)<br>    go func2(&amp;resp)<br>}<br>è¿™é‡Œfunc2åœ¨handleä¹‹å‰å¿…é¡»ä¿è¯func1å·²ç»ç”Ÿäº§å‡ºrespã€‚åœ¨Goï¼Œè¿™ä¸€èˆ¬ç”¨channelæ¥å®ç°ã€‚è¿™é‡Œä¸èƒ½ç”¨sync.Onceæ˜¯å› ä¸ºfunc2æ²¡æœ‰ç”Ÿäº§èƒ½åŠ›ï¼Œfunc2è°ƒç”¨sync.Onceä¼šå¯¼è‡´RPCè°ƒç”¨ä¸äº†ã€‚</p>
<p>æœ€åˆçš„æƒ³æ³•ï¼šæ··åˆsync.Onceä¸channel<br>æˆ‘æƒ³åšä¸€ä¸ªé€šç”¨çš„åŒ…è£¹æ¥åŒ…ä½respï¼Œåšä¸€ä¸ªé€šç”¨çš„æ•°æ®è·å–æ¥å£è·å–respï¼Œä½¿å…¶èƒ½å›Šæ‹¬ä¸Šé¢ä¸¤ç§æƒ…å†µã€‚äºæ˜¯æˆ‘æ··åˆäº†sync.Onceä¸channelï¼Œå†™å‡ºäº†ä¸‹é¢çš„ä»£ç ã€‚æ ¸å¿ƒæ˜¯æä¾›äº†InitAndGetæ¥å£æ¥ç”Ÿäº§æ•°æ®ï¼ŒGetæ¥å£æ¥è·å–æ•°æ®ã€‚</p>
<p>type DataGetter[T any] struct {<br>    Data     T<br>    DataOnce sync.Once<br>    SelfOnce sync.Once<br>    IsReady  chan struct{}<br>}</p>
<p>func (d *DataGetter[T]) InitAndGet(initFunc func(*T)) *T {<br>    d.InitSelf()<br>    d.DataOnce.Do(func() {<br>        DoInit(initFunc)<br>    })<br>    &lt;-d.IsReady<br>    return &amp;d.Data<br>}</p>
<p>func (d *DataGetter[T]) Get() *T {<br>    d.InitSelf()<br>    &lt;-d.IsReady<br>    return &amp;d.Data<br>}</p>
<p>func (d *DataGetter[T]) InitSelf() {<br>    d.SelfOnce.Do(func() {<br>        d.IsReady &#x3D; make(chan struct{})<br>    })<br>}</p>
<p>func (d *DataGetter[T]) DoInit(initFunc func(*T)) {<br>    defer func() {<br>        recover()<br>        close(d.IsReady)<br>    }()<br>    if initFunc !&#x3D; nil {<br>        initFunc(&amp;d.Data)<br>    }<br>}<br>äºæ˜¯ä¸Šé¢ä¸¤ä¸ªCaseå¯ä½œå¦‚ä¸‹æ”¹å†™ã€‚</p>
<p>func func1(resp *DataGetter[Resp]) {<br>    handle1(resp.InitAndGet(func(r *Resp) {<br>        *r &#x3D; RPC()<br>    }))<br>}</p>
<p>func func2(resp *DataGetter[Resp]) {<br>    handle2(resp.InitAndGet(func(r *Resp) {<br>        *r &#x3D; RPC()<br>    }))<br>}</p>
<p>func Case1() {<br>    var resp DataGetter[Resp]<br>    go func1(&amp;resp)<br>    go func2(&amp;resp)<br>}<br>func func1(resp *DataGetter[Resp]) {<br>    resp.InitAndGet(func(r *Resp) {<br>        *r &#x3D; RPC()<br>    })<br>}</p>
<p>func func2(resp *DataGetter[Resp]) {<br>    handle(resp.Get())<br>}</p>
<p>func Case2() {<br>    var resp DataGetter[Resp]<br>    go func1(&amp;resp)<br>    go func2(&amp;resp)<br>}<br>Getæ¥å£çš„å±é™©<br>çœ‹èµ·æ¥æ»¡è¶³éœ€æ±‚äº†ã€‚ä½†å¾ˆå¿«æˆ‘ä¾¿å‘ç°ï¼ŒGetæ¥å£éå¸¸å±é™©ã€‚æˆ‘ä»¬çœ‹ä¸‹é¢Case3ï¼Œæˆ‘æŠŠCase2çš„func1åŠ äº†ä¸ªifã€‚</p>
<p>func func1(resp *DataGetter[Resp]) {<br>    if Condition() {<br>        resp.InitAndGet(func(r *Resp) {<br>            *r &#x3D; RPC()<br>        })<br>    }<br>}</p>
<p>func func2(resp *DataGetter[Resp]) {<br>    handle(resp.Get())<br>}</p>
<p>func Case3() {<br>    var resp DataGetter[Resp]<br>    go func1(&amp;resp)<br>    go func2(&amp;resp)<br>}<br>å¦‚æœCondition()ä¸ºfalseï¼Œfunc1æ²¡æœ‰ç”Ÿäº§æ•°æ®ï¼Œfunc2å°±ä¼šæ— é™ç­‰å¾…ã€‚æˆ‘ä»¬è¦åŠ å¼ºGetæ¥å£çš„å®‰å…¨æ€§ã€‚é¦–å…ˆä¼šæƒ³åˆ°çš„æ˜¯åŠ ä¸€ä¸ªè¶…æ—¶ï¼Œè¿™æ˜¯åº”è¯¥çš„ï¼Œä½†æ˜¯è¶…æ—¶åªæ˜¯æœ€åçš„å…œåº•ï¼Œå®ƒä¸ä¼šå¸®ä½ æŠŠæ•°æ®ç”Ÿäº§å‡ºæ¥ã€‚æˆ‘ä»¬è¦åšçš„æ˜¯åŠ ä»¥é™åˆ¶ï¼Œä»é€»è¾‘ä¸Šé¿å…å‡ºç°æœ‰æ¶ˆè´¹ä½†æ²¡æœ‰ç”Ÿäº§æ•°æ®çš„æƒ…å†µã€‚</p>
<p>æˆ‘å…ˆç®€å•ä¿®ä¸€ä¸‹Case3ã€‚</p>
<p>func func1(resp *DataGetter[Resp]) {<br>    defer resp.InitAndGet(nil)<br>    if Condition() {<br>        resp.InitAndGet(func(r *Resp) {<br>            *r &#x3D; RPC()<br>        })<br>    }<br>}</p>
<p>func func2(resp *DataGetter[Resp]) {<br>    handle(resp.Get())<br>}</p>
<p>func Case3() {<br>    var resp DataGetter[Resp]<br>    go func1(&amp;resp)<br>    go func2(&amp;resp)<br>}<br>æˆ‘åœ¨func1ä¸­åŠ äº†ä¸€è¡Œdeferï¼Œè¡¨ç¤ºå¦‚æœCondition()ä¸ºfalseï¼Œrespå°±ä¸ä¼šç”Ÿäº§äº†ï¼Œfunc2çš„handleå°±ä¸ä¼šæ°¸è¿œé˜»å¡ï¼Œä½†æ˜¯è¦å¤„ç†æ²¡æ•°æ®çš„æƒ…å†µã€‚è¿™ä¸ªfixå¤„ç†äº†æ°¸è¿œé˜»å¡çš„æƒ…å†µï¼Œä½†å‰ææ˜¯func1ä¸€å®šä¼šè¿è¡Œã€‚</p>
<p>func func1(resp *DataGetter[Resp]) {<br>    if Condition() {<br>        resp.InitAndGet(func(r *Resp) {<br>            *r &#x3D; RPC()<br>        })<br>    }<br>}</p>
<p>func func2(resp *DataGetter[Resp]) {<br>    handle(resp.Get())<br>}</p>
<p>func func3(resp *DataGetter[Resp]) {<br>    defer resp.InitAndGet(nil)<br>    if Condition2() {<br>        func1(resp)<br>    }<br>}</p>
<p>func Case4() {<br>    var resp DataGetter[Resp]<br>    go func3(&amp;resp)<br>    go func2(&amp;resp)<br>}<br>åœ¨Case4ä¸­ï¼Œfunc1å¹¶ä¸æ˜¯ä¸€å®šä¼šè¿è¡Œçš„ï¼Œfunc3æ‰æ˜¯ä¸€å®šä¼šè¿è¡Œçš„ï¼Œæ‰€ä»¥deferè¯­å¥æŒªåˆ°func3ã€‚è¿™æ ·äº§ç”Ÿä¸€ä¸ªé—®é¢˜ï¼ŒRPCä»£ç åœ¨func1ä¸åœ¨func3ï¼Œçœ‹func3ä»£ç æ—¶ä¼šè§‰å¾—è«åå…¶å¦™ã€‚æ›´è¦å‘½çš„æ˜¯ï¼Œé™¤äº†æ¢³ç†ä»£ç ï¼Œæ²¡æœ‰ä»»ä½•æ–¹å¼æ¥æ£€æµ‹æˆ‘è¿™ä¸ªdeferå†™çš„ä½ç½®ç©¶ç«Ÿå¯¹ä¸å¯¹ï¼Ÿdeferç©¶ç«Ÿåº”è¯¥å†™åœ¨func1è¿˜æ˜¯func3è¿˜æ˜¯åˆ«çš„å‡½æ•°ï¼Ÿæœ‰æ²¡æœ‰æ¼å†™ï¼Ÿå†™é”™çš„è¯ä¾ç„¶ä¼šé€ æˆæ— é™ç­‰å¾…ã€‚æ€ä¹ˆåŠå‘¢ï¼Ÿ</p>
<p>æ˜ç¡®çŸ¥é“Initåœ¨Getä¹‹å‰<br>æœ‰ä¸€ä¸ªæ¯”è¾ƒç®€å•çš„caseæ˜¯func2çš„handleçŸ¥é“ï¼Œå¦‚æœrespæœ‰æ•°æ®ï¼Œrespä¸€å®šä¼šåœ¨hanleä¹‹å‰è°ƒç”¨InitAndGetï¼Œé‚£ä¹ˆhandleåªéœ€è¦å†è°ƒç”¨ä¸€æ¬¡InitAndGet(nil)å°±å¯ä»¥ä¿è¯ä¸æ— é™ç­‰å¾…äº†ã€‚ç”±äºåªæœ‰åŒæ­¥æ“ä½œèƒ½ä¿è¯å…ˆåé¡ºåºï¼Œä¸ºäº†æ–¹ä¾¿handleä¸respçš„è·å–åœ¨ä¸åŒåç¨‹ä¸Šè¿›è¡Œï¼Œæˆ‘åœ¨DataGetterå¢åŠ äº†ä¸€ä¸ªAsyncInitæ¥å£ã€‚</p>
<p>func (d *DataGetter[T]) AsyncInit(initFunc func(*T)) {<br>    d.InitSelf()<br>    d.DataOnce.Do(func() {<br>        go DoInit(initFunc)<br>    })<br>}<br>å…¶å®è¿™ä¸ªAsyncInitçš„å®ç°æ˜¯æœ‰é—®é¢˜çš„ï¼Œå¦‚æœåœ¨AsyncInitä¹‹å‰è¢«è°ƒç”¨äº†InitAndGetï¼ŒAsyncInitå°±ä¼šåŒæ­¥ç­‰åˆ°InitAndGetç»“æŸï¼Œä¸ç¬¦åˆAyncInitç»™äººçš„æ„Ÿè§‰ã€‚è¿™é‡Œä¸ºäº†ä¾¿äºç†è§£å…ˆè¿™æ ·å†™ç€ï¼Œæœ¬æ–‡æœ€åä¼šç»™å‡ºä¿®æ­£åçš„å®Œæ•´ä»£ç ã€‚Case5æ˜¯ä¸€ä¸ªå…¸å‹çš„åº”ç”¨åœºæ™¯ã€‚</p>
<p>func Case5() {<br>    var resp DataGetter[Resp]<br>    resp.AsyncInit(func(r *Resp) {<br>        *r &#x3D; RPC()<br>    })<br>    handle(resp.InitAndGet(nil))<br>}<br>promise<br>å¯¹äºæ›´ä¸€èˆ¬çš„æƒ…å†µæ€ä¹ˆåŠå‘¢ï¼Ÿäºæ˜¯æˆ‘å€Ÿé‰´åˆ«çš„ç¼–ç¨‹è¯­è¨€ï¼Œå‘ç°äº†ä¸€ä¸ªå«promiseçš„ä¸œè¥¿ï¼Œæˆ‘å†³å®šæŠŠçš„std::promiseæŠ„è¿‡æ¥ã€‚promiseçš„æ€æƒ³æ˜¯ï¼Œæˆ‘åœ¨Getçš„æ—¶å€™ï¼Œè¦æŒ‡å®šä¸€ä¸ªpromiseï¼Œè¿™ä¸ªpromiseå¹¶ä¸æ˜¯è¯´ä¿è¯ä¼šç”Ÿäº§æ•°æ®ï¼Œè€Œæ˜¯è¯´ä¿è¯è¿™ä¸ªæ•°æ®åªä¼šåœ¨promiseçš„å†…ç”Ÿäº§ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœpromiseçš„ç”Ÿå‘½å‘¨æœŸç»“æŸäº†ï¼Œé‚£ä¹ˆæ•°æ®å°±ä¸ä¼šå†ç”Ÿäº§ã€‚æ›´å‡†ç¡®åœ°è¯´ï¼Œæˆ‘å¯¹promiseæå‡ºäº†ä¸‹é¢å‡ ä¸ªè¦æ±‚ã€‚</p>
<p>promiseåœ¨Getä¹‹å‰å¿…é¡»å·²åˆå§‹åŒ–ã€‚<br>promiseçš„ç”Ÿå‘½å‘¨æœŸä¸€å®šä¼šç»“æŸï¼Œä¸ä¼šæ— é™ç­‰å¾…ã€‚<br>å¦‚æœæ•°æ®ä¼šç”Ÿäº§ï¼Œåˆ™ä¸€å®šä¼šåœ¨promiseçš„ç”Ÿå‘½å‘¨æœŸç»“æŸä¹‹å‰è°ƒç”¨InitAndGetæˆ–AsyncInitã€‚<br>promiseç”¨channelæ¥å®ç°å°±å¥½äº†ï¼Œç”¨makeæ¥è¡¨ç¤ºpromiseçš„åˆå§‹åŒ–ï¼Œç”¨closeæ¥è¡¨ç¤ºpromiseç”Ÿå‘½å‘¨æœŸçš„ç»“æŸã€‚åŠ ä¸Šä¸Šæ–‡æåˆ°çš„è¦åŠ ä¸ªè¶…æ—¶ï¼Œå› ä¸ºDataGetterä½œä¸ºä¸€ä¸ªé€šç”¨çš„ä¸œè¥¿ï¼Œå¹¶ä¸çŸ¥é“è¶…æ—¶å¤šå°‘æ˜¯åˆç†çš„ï¼Œäºæ˜¯å°±äº¤ç»™å¤–éƒ¨æ¥è®¾å®šï¼Œç›´æ¥é‡‡ç”¨contextçš„è¶…æ—¶ã€‚äºæ˜¯Getæ¥å£å°±æ”¹æˆä¸‹é¢è¿™æ ·ã€‚</p>
<p>func (d *DataGetter[T]) Get(ctx context.Context, promise chan struct{}) *T {<br>    d.InitSelf()<br>    select {<br>    case &lt;-promise:<br>        return d.InitAndGet(nil)<br>    case &lt;-d.IsReady:<br>        return &amp;d.Data<br>    case &lt;-ctx.Done():<br>        return d.InitAndGet(nil)<br>    }<br>}<br>Case4å°±æ”¹å†™æˆä¸‹é¢è¿™æ ·ã€‚</p>
<p>func func1(resp *DataGetter[Resp]) {<br>    if Condition() {<br>        resp.InitAndGet(func(r *Resp) {<br>            *r &#x3D; RPC()<br>        })<br>    }<br>}</p>
<p>func func2(ctx, context.Context, resp *DataGetter[Resp], func3Promise chan struct{}) {<br>    handle(resp.Get(ctx, func3Promise))<br>}</p>
<p>func func3(resp *DataGetter[Resp], func3Promise chan struct{}) {<br>    defer close(func3Promise)<br>    if Condition2() {<br>        func1(resp)<br>    }<br>}</p>
<p>func Case4() {<br>    ctx, cancel :&#x3D; context.WithTimeout(context.Background(), time.Second)<br>    defer cancel()<br>    var resp DataGetter[Resp]<br>    func3Promise :&#x3D; make(chan struct{})<br>    go func3(&amp;resp, func3Promise)<br>    go func2(ctx, &amp;resp, func3Promise)<br>}<br>è¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼š</p>
<p>func3Promiseæ˜¯åªè·Ÿfunc3æœ‰å…³ï¼Œè·Ÿrespæ— å…³çš„ï¼Œå³ä½¿æœ‰resp2ã€resp3ç­‰ä¹Ÿå¯ä»¥ç”¨func3Promiseã€‚åœ¨func3 close func3Promiseä¹Ÿä¸ä¼šè§‰å¾—å¥‡æ€ªã€‚<br>promiseè·Ÿrespçš„ç”Ÿäº§æ— å…³ï¼Œè·Ÿæ¶ˆè´¹æœ‰å…³ï¼Œæ˜¯Getçš„æ—¶å€™é€‰æ‹©çš„ã€‚ç”Ÿäº§å¯ä»¥æ— å‹åŠ›åœ°å†™ç”Ÿäº§ä»£ç ï¼Œä¸ç”¨æ‹…å¿ƒæŸä¸ªifelseæ²¡è¦†ç›–åˆ°ã€‚ä¸åŒçš„åœ°æ–¹Getçš„æ—¶å€™å¯ä»¥é€‰æ‹©ä¸åŒçš„promiseã€‚<br>å¦‚æœGeté€‰é”™promiseï¼Œpromiseåœ¨Getçš„æ—¶å€™æ²¡æœ‰åˆå§‹åŒ–ï¼Œé‚£ä¹ˆç¨‹åºä¼španicã€‚æˆ‘è®¤ä¸ºpanicæ˜¯æ¯”è¾ƒå¥½å®šä½çš„é”™è¯¯ï¼Œå› ä¸ºå¯ä»¥çœ‹å †æ ˆã€‚<br>ç¼ºç‚¹æ˜¯Getçš„æ—¶å€™ç¡®å®éœ€è¦è°¨æ…é€‰æ‹©promiseï¼Œä½¿promiseæ»¡è¶³ä¸Šé¢è¯´çš„promiseçš„å‡ ä¸ªæ¡ä»¶ã€‚ä¸€èˆ¬åœ¨ç”Ÿäº§ä¸æ¶ˆè´¹åˆ†å‰ä¹‹å‰ä»¤promiseåˆå§‹åŒ–ï¼Œæ¯”å¦‚Case4å‡½æ•°ï¼Œåœ¨åˆ†å‰ä¹‹åçš„ç”Ÿäº§æ–¹çš„ç¬¬ä¸€ä¸ªå‡½æ•°è¿›è¡Œcloseï¼Œæ¯”å¦‚func3ã€‚</p>
<p>move promise<br>æœ‰æ—¶å€™å¹¶ä¸èƒ½ç®€å•æŒ‰ä¸Šé¢çš„promiseè§„åˆ™ï¼Œæ¯”å¦‚ä¸‹é¢çš„Case6ï¼Œæˆ‘æŠŠCase4ä¸­func3ä¸­çš„func1è°ƒç”¨æ”¹ä¸ºäº†go func1ã€‚</p>
<p>func func1(resp *DataGetter[Resp]) {<br>    if Condition() {<br>        resp.InitAndGet(func(r *Resp) {<br>            *r &#x3D; RPC()<br>        })<br>    }<br>}</p>
<p>func func2(ctx, context.Context, resp *DataGetter[Resp], func3Promise chan struct{}) {<br>    handle(resp.Get(ctx, func3Promise))<br>}</p>
<p>func func3(resp *DataGetter[Resp], func3Promise chan struct{}) {<br>    defer close(func3Promise)<br>    if Condition2() {<br>        go func1(resp)<br>    }<br>}</p>
<p>func Case6() {<br>    ctx, cancel :&#x3D; context.WithTimeout(context.Background(), time.Second)<br>    defer cancel()<br>    var resp DataGetter[Resp]<br>    func3Promise :&#x3D; make(chan struct{})<br>    go func3(&amp;resp, func3Promise)<br>    go func2(ctx, &amp;resp, func3Promise)<br>}<br>äºæ˜¯å°±å‡ºé—®é¢˜äº†ï¼Œfunc3Promiseè¢«closeçš„æ—¶å€™å¯èƒ½func1è¿˜æ²¡è¢«è°ƒç”¨ï¼Œå¯¼è‡´respçš„ç”Ÿäº§åœ¨func3Promiseç”Ÿå‘½å‘¨æœŸä¹‹åï¼Œä¸æ»¡è¶³promiseå®šä¹‰ã€‚æ€ä¹ˆåŠå‘¢ï¼Ÿæˆ‘åˆæŠŠç›®å…‰æŠ•å‘C++ï¼Œå‘ç°è¿˜æœ‰ä¸ªstd::moveçš„è¯­ä¹‰ï¼Œäºæ˜¯æˆ‘åˆæŠŠå®ƒæŠ„è¿‡æ¥äº†ã€‚Goè¯­è¨€é‡Œä¸€èˆ¬æ²¡æœ‰moveçš„æ¦‚å¿µï¼Œæˆ‘æŠ„ä»€ä¹ˆå‘¢ï¼ŸæŠ„ææ„å‡½æ•°è°ƒç”¨çš„æ—¶æœºã€‚åœ¨C++é‡Œï¼Œå¦‚æœä¸€ä¸ªpromiseè¢«moveåˆ°æ–°çš„å˜é‡ï¼Œé‚£ä¹ˆåŸå˜é‡å°±ä¸ä¼šæ‰§è¡Œææ„å‡½æ•°ã€‚æˆ‘å°±æŠ„è¿™ä¸ªé€»è¾‘ã€‚ä¸‹é¢æ˜¯æ”¹å†™åçš„Case6ã€‚</p>
<p>func func1(resp *DataGetter[Resp], func1Promise chan struct{}) {<br>    defer close(func1Promise)<br>    if Condition() {<br>        resp.InitAndGet(func(r *Resp) {<br>            *r &#x3D; RPC()<br>        })<br>    }<br>}</p>
<p>func func2(ctx, context.Context, resp *DataGetter[Resp], func1Promise chan struct{}) {<br>    handle(resp.Get(ctx, func1Promise))<br>}</p>
<p>func func3(resp *DataGetter[Resp], func1Promise chan struct{}) {<br>    isFun1PromiseMoved :&#x3D; false<br>    defer func() {<br>        if !isFun1PromiseMoved {<br>            close(func1Promise)<br>        }<br>    }()<br>    if Condition2() {<br>        isFun1PromiseMoved &#x3D; true<br>        go func1(resp, func1Promise)<br>    }<br>}</p>
<p>func Case6() {<br>    ctx, cancel :&#x3D; context.WithTimeout(context.Background(), time.Second)<br>    defer cancel()<br>    var resp DataGetter[Resp]<br>    func1Promise :&#x3D; make(chan struct{})<br>    go func3(&amp;resp, func1Promise)<br>    go func2(ctx, &amp;resp, func1Promise)<br>}<br>å‡½æ•°åŠåœ¨å‡½æ•°ç”Ÿå‘½å‘¨æœŸå‘èµ·çš„åç¨‹çš„æ€»ç”Ÿå‘½å‘¨æœŸ<br>é—®é¢˜æ˜¯è§£å†³äº†ï¼Œä½†æ˜¯ï¼Œè¿™æ€ä¹ˆè¿™ä¹ˆå¤æ‚ï¼Ÿè€Œä¸”å¹¶æ²¡æœ‰å¾ˆé€šç”¨ã€‚æ¯”å¦‚ä¸‹é¢çš„Case7å°±ä¸è¡Œäº†ï¼Œfunc1è¢«è°ƒç”¨å¤šæ¬¡ï¼Œå…¶ä¸­ç¬¬ä¸€æ¬¡å¹¶ä¸å‘èµ·rpcï¼Œç¬¬äºŒæ¬¡æ‰å‘èµ·ã€‚</p>
<p>func func1(resp *DataGetter[Resp], func1Promise chan struct{}, condition bool) {<br>    defer close(func1Promise)<br>    if condition {<br>        resp.InitAndGet(func(r *Resp) {<br>            *r &#x3D; RPC()<br>        })<br>    }<br>}</p>
<p>func func2(ctx, context.Context, resp *DataGetter[Resp], func1Promise chan struct{}) {<br>    handle(resp.Get(ctx, func1Promise))<br>}</p>
<p>func func3(resp *DataGetter[Resp], func1Promise chan struct{}) {<br>    isFun1PromiseMoved :&#x3D; false<br>    defer func() {<br>        if !isFun1PromiseMoved {<br>            close(func1Promise)<br>        }<br>    }()<br>    if Condition2() {<br>        isFun1PromiseMoved &#x3D; true<br>        go func1(resp, func1Promise, false)<br>    }<br>    if Condition3() {<br>        isFun1PromiseMoved &#x3D; true<br>        go func1(resp, func1Promise, true)<br>    }<br>}</p>
<p>func Case7() {<br>    ctx, cancel :&#x3D; context.WithTimeout(context.Background(), time.Second)<br>    defer cancel()<br>    var resp DataGetter[Resp]<br>    func1Promise :&#x3D; make(chan struct{})<br>    go func3(&amp;resp, func1Promise)<br>    go func2(ctx, &amp;resp, func1Promise)<br>}<br>äºæ˜¯æˆ‘åˆæƒ³äº†ä¸€æƒ³ï¼Œå‘ç°æˆ‘å¯èƒ½æŠ„é”™ä½œä¸šäº†ï¼Œæœ‰ä¸€ä¸ªæ›´æ— è„‘çš„è¯­ä¹‰å¯ä»¥ç”¨ï¼šfunc3åŠåœ¨func3ç”Ÿå‘½å‘¨æœŸé‡Œå‘èµ·çš„åç¨‹çš„æ€»çš„ç”Ÿå‘½å‘¨æœŸã€‚äºæ˜¯Case7æ”¹å†™æˆä¸‹é¢è¿™æ ·ã€‚</p>
<p>func func1(resp *DataGetter[Resp], func1Promise chan struct{}, condition bool) {<br>    defer close(func1Promise)<br>    if condition {<br>        resp.InitAndGet(func(r *Resp) {<br>            *r &#x3D; RPC()<br>        })<br>    }<br>}</p>
<p>func func2(ctx, context.Context, resp *DataGetter[Resp], func3Promise chan struct{}) {<br>    handle(resp.Get(ctx, func3Promise))<br>}</p>
<p>func func3(resp *DataGetter[Resp], func3Promise chan struct{}) {<br>    subPromises :&#x3D; make([]chan struct{}, 0)<br>    defer func() {<br>        go func() {<br>            for _, promise :&#x3D; range subPromises {<br>                &lt;-promise<br>            }<br>            close(func3Promise)<br>        }()<br>    }()<br>    if Condition2() {<br>        func1Promise :&#x3D; make(chan struct{})<br>        subPromises &#x3D; append(subPromises, func1Promise)<br>        go func1(resp, func1Promise, false)<br>    }<br>    if Condition3() {<br>        func1Promise :&#x3D; make(chan struct{})<br>        subPromises &#x3D; append(subPromises, func1Promise)<br>        go func1(resp, func1Promise, true)<br>    }<br>}</p>
<p>func Case7() {<br>    ctx, cancel :&#x3D; context.WithTimeout(context.Background(), time.Second)<br>    defer cancel()<br>    var resp DataGetter[Resp]<br>    func3Promise :&#x3D; make(chan struct{})<br>    go func3(&amp;resp, func3Promise)<br>    go func2(ctx, &amp;resp, func3Promise)<br>}<br>è¿™ä¸ªè¯­ä¹‰å°±æ— è„‘å¤šäº†ï¼Œæ¯è§åˆ°ä¸€ä¸ªå¯èƒ½ç”Ÿäº§æ•°æ®çš„å‡½æ•°è°ƒç”¨å°±åŠ ä¸€ä¸ªsubPromiseå°±è¡Œäº†ã€‚</p>
<p>æ€»ç»“<br>æ€»çš„æ¥è¯´ï¼Œpromiseå°±æ˜¯è¦åˆ’å®šä¸€ä¸ªèŒƒå›´ï¼Œä»ç”Ÿäº§è€…æ¶ˆè´¹è€…åˆ†å¼€ä¹‹å‰å¼€å§‹ï¼Œåˆ°æ‰€æœ‰å¯èƒ½å‘ç”Ÿç”Ÿäº§çš„è·¯å¾„çš„èŒƒå›´ã€‚å¤§å¤šæ•°æ—¶å€™ï¼Œæˆ‘ä»¬åªéœ€è¦æ— è„‘åˆ’å®šä¸€ä¸ªå¾ˆç²—çš„èŒƒå›´å°±è¶³å¤Ÿäº†ï¼Œæ¯”å¦‚Case4ï¼ŒCase5ï¼ŒCase7ï¼ˆCase4å¯çœ‹ä½œpromiseåœ¨Getè°ƒç”¨çš„æ—¶å€™closeæ‰ï¼‰ã€‚æœ‰æ—¶å€™å¯èƒ½çœŸçš„éœ€è¦ä¸€äº›å¾ˆç²¾ç»†çš„æ“ä½œå»åˆ’å®šä¸€ä¸ªå¾ˆç²¾ç¡®çš„èŒƒå›´ï¼Œä¸è¿‡æˆ‘æš‚æ—¶è¿˜æ²¡é‡åˆ°è¿‡ï¼Œå°±è¿™æ ·å§ï¼Œç­‰æˆ‘é‡åˆ°äº†å†æ¥è¡¥å……ã€‚</p>
<p>å¦å¤–æä¸€å¥ï¼Œæˆ‘åæ¥å°´å°¬åœ°å‘ç°ï¼Œå…¶å®ç”¨DataGetteråŒ…ä½æ•°æ®çš„æ–¹å¼æ˜¯å¾ˆåäººç±»çš„ï¼Œå› ä¸ºè¿™æ”¹å˜äº†ç”Ÿäº§è€…çš„ä»£ç ã€‚å†™ç”Ÿäº§ä»£ç çš„æ—¶å€™å¯èƒ½å¹¶ä¸çŸ¥é“å“ªä¸ªæ•°æ®éœ€è¦ç”¨DataGetteråŒ…ç€ï¼Œç­‰åˆ°å†™æ¶ˆè´¹è€…çš„æ—¶å€™æ‰çŸ¥é“ã€‚æ‰€ä»¥ï¼Œåƒsync.Onceè¿™æ ·ï¼Œåœ¨æ•°æ®ä¹‹å¤–è‡ªè¡Œåˆ›å»ºä¸€ä¸ªå˜é‡æ‰æ˜¯æ›´å¥½çš„æ–¹å¼ã€‚æ‰€ä»¥ç›´æ¥ç”¨DataGetter[struct{}]å°±å¥½äº†ã€‚è¿™æ ·çš„è¯å®é™…ä¸Šä¸éœ€è¦ç”¨æ³›å‹äº†ï¼Œå¯ä»¥æ”¯æŒæ›´ä½ç‰ˆæœ¬çš„Goã€‚</p>
<p>å†™äº†è¿™ä¹ˆå¤šï¼Œå¯èƒ½å¤§å®¶ä¼šç–‘æƒ‘è¿™è·Ÿå¼€å¤´è¯´çš„æœ€ä¼˜ä¸²å¹¶è¡Œæœ‰ä»€ä¹ˆå…³ç³»å•Šï¼Ÿå…¶å®æˆ‘å†™äº†è¿™ä¹ˆå¤šï¼Œå°±æ˜¯ä¸ºäº†é™ä½é—¨æ§›ï¼Œè®©å¤§å®¶å¯ä»¥éšå¿ƒæ‰€æ¬²åœ°åœ¨ç¨‹åºçš„å„ä¸ªåœ°æ–¹èµ·åç¨‹å‘èµ·rpcï¼ŒåŒæ—¶å¯ä»¥éšå¿ƒæ‰€æ¬²åœ°è·å–å…¶ä»–åç¨‹çš„rpcç»“æœã€‚ä¸ºäº†è¾¾åˆ°å…¨å±€æœ€ä¼˜ï¼Œæˆ‘çš„æ–¹æ³•ä¸æ˜¯å®è§‚ç®¡æ§ï¼Œè€Œæ˜¯åšå¥½æ¯ä¸€ä¸ªå¾®è§‚é€»è¾‘ã€‚ä¸€ä¸ªå…¸å‹çš„æ–°éœ€æ±‚çš„å¼€å‘æµç¨‹æ˜¯è¿™æ ·çš„ï¼šåœ¨ä¸€ä¸ªåˆé€‚çš„åœ°æ–¹èµ·ä¸€ä¸ªåç¨‹è¿›å…¥æ–°éœ€æ±‚çš„æµç¨‹ï¼Œçœ‹çœ‹æ–°éœ€æ±‚ä¾èµ–çš„æ•°æ®åœ¨æ—§ä»£ç çš„å“ªé‡Œç”Ÿäº§ï¼Œåœ¨ç”Ÿäº§çš„åœ°æ–¹åŠ ä¸ŠDataGetterï¼Œç„¶ååœ¨æ–°éœ€æ±‚çš„åç¨‹é‡Œç­‰å¾…ç»“æœï¼Œç­‰åˆ°ç»“æœé©¬ä¸Šå¼€å§‹ç”Ÿäº§æ–°éœ€æ±‚çš„æ•°æ®ï¼Œå¹¶åŠ ä¸ŠDataGetterï¼Œæ–°éœ€æ±‚çš„æ•°æ®éœ€è¦åˆå…¥æ—§é€»è¾‘æ¥æ”¹å˜æ—§é€»è¾‘çš„è¾“å‡ºï¼Œé‚£ä¹ˆåœ¨éœ€è¦æ”¹å˜æ—§é€»è¾‘çš„åœ°æ–¹ï¼Œç”¨DataGetterå»ç­‰å¾…æ–°éœ€æ±‚çš„æ•°æ®ï¼Œä¸€ä½†ç­‰åˆ°äº†é©¬ä¸Šå¼€å§‹æ”¹å˜ã€‚ä½ çœ‹ï¼Œè¿™ä¸å°±æ»¡è¶³äº†æœ€ä¼˜ä¸²å¹¶è¡Œçš„è¦æ±‚äº†å—ï¼Ÿå¦‚æœæ—§é€»è¾‘æ˜¯å…¨å±€æœ€ä¼˜çš„ï¼Œé‚£ä¹ˆåŠ å…¥æ–°éœ€æ±‚åçš„é€»è¾‘ä¹Ÿä¾ç„¶æ˜¯å…¨å±€æœ€ä¼˜çš„ã€‚è¿™å¯ç»´æŠ¤æ€§æ‹‰æ»¡äº†å•Šã€‚</p>
<p>å®Œæ•´ä»£ç <br>ä¸‹é¢æ˜¯DataGetterå®Œæ•´çš„ä»£ç ï¼Œä¿®å¤äº†ä¸Šé¢è¯´çš„AsyncInitçš„é—®é¢˜ï¼Œå»é™¤äº†æ³›å‹ã€‚</p>
<p>type DataGetterState &#x3D; int32</p>
<p>const (<br>    DataGetterStateNotStarted DataGetterState &#x3D; 0<br>    DataGetterStateStarted    DataGetterState &#x3D; 1<br>    DataGetterStateDone       DataGetterState &#x3D; 2<br>)</p>
<p>type DataGetter struct {<br>    State    DataGetterState<br>    SelfOnce sync.Once<br>    IsReady  chan struct{}<br>}</p>
<p>func (d *DataGetter) AsyncInit(initFunc func()) {<br>    if !d.IsMyTurn() {<br>        return<br>    }<br>    d.InitSelf()<br>    go d.DoInit(initFunc)<br>}</p>
<p>func (d *DataGetter) IsMyTurn() bool {<br>    return atomic.CompareAndSwapInt32(&amp;d.State, DataGetterStateNotStarted, DataGetterStateStarted)<br>}</p>
<p>func (d *DataGetter) Get(ctx context.Context, promise chan struct{}) {<br>    if atomic.LoadInt32(&amp;d.State) &#x3D;&#x3D; DataGetterStateDone {<br>        return<br>    }<br>    d.InitSelf()<br>    select {<br>    case &lt;-promise:<br>        d.InitAndGet(nil)<br>        return<br>    case &lt;-d.IsReady:<br>        return<br>    case &lt;-ctx.Done():<br>        d.InitAndGet(nil)<br>        return<br>    }<br>}</p>
<p>func (d *DataGetter) InitAndGet(initFunc func()) {<br>    if atomic.LoadInt32(&amp;d.State) &#x3D;&#x3D; DataGetterStateDone {<br>        return<br>    }<br>    d.InitSelf()<br>    if d.IsMyTurn() {<br>        d.DoInit(initFunc)<br>    }<br>    &lt;-d.IsReady<br>}</p>
<p>func (d *DataGetter) DoInit(initFunc func()) {<br>    defer func() {<br>        recover()<br>        close(d.IsReady)<br>        atomic.StoreInt32(&amp;d.State, DataGetterStateDone)<br>    }()<br>    if initFunc !&#x3D; nil {<br>        initFunc()<br>    }<br>}</p>
<p>func (d *DataGetter) InitSelf() {<br>    d.SelfOnce.Do(func() {<br>        d.IsReady &#x3D; make(chan struct{})<br>    })<br>}</p>

      
       <hr><span style="font-style: italic;color: gray;"> è½¬è½½è¯·æ³¨æ˜æ¥æºï¼Œæ¬¢è¿å¯¹æ–‡ç« ä¸­çš„å¼•ç”¨æ¥æºè¿›è¡Œè€ƒè¯ï¼Œæ¬¢è¿æŒ‡å‡ºä»»ä½•æœ‰é”™è¯¯æˆ–ä¸å¤Ÿæ¸…æ™°çš„è¡¨è¾¾ã€‚å¯ä»¥åœ¨ä¸‹é¢è¯„è®ºåŒºè¯„è®ºï¼Œä¹Ÿå¯ä»¥é‚®ä»¶è‡³ jaytp@qq.com </span>
    </div>
</article>


<p>
    <a  class="dashang" onclick="dashangToggle()">ğŸ’°</a>
</p>






    




    </div>
    <div class="copyright">
        <p class="footer-entry">
    Â©2016-2020 Yelog
</p>
<p class="footer-entry">Built with <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/yelog/hexo-theme-3-hexo" target="_blank">3-hexo</a> theme</p>

    </div>
    <div class="full-toc">
        <button class="full" data-title="åˆ‡æ¢å…¨å± å¿«æ·é”® s"><span class="min "></span></button>
<a class="" id="rocket" ></a>

    </div>
</div>

<div class="hide_box" onclick="dashangToggle()"></div>
<div class="shang_box">
    <a class="shang_close"  onclick="dashangToggle()">Ã—</a>
    <div class="shang_tit">
        <p>Help us with donation</p>
    </div>
    <div class="shang_payimg">
        <div class="pay_img">
            <img src="/img/alipay.jpg" class="alipay" title="æ‰«ç æ”¯æŒ">
            <img src="/img/weixin.jpg" class="weixin" title="æ‰«ç æ”¯æŒ">
        </div>
    </div>
    <div class="shang_payselect">
        <span><label><input type="radio" name="pay" checked value="alipay">alipay</label></span><span><label><input type="radio" name="pay" value="weixin">weixin</label></span>
    </div>
</div>


</body>
<script src="/js/jquery.pjax.js?v=1.1.0" ></script>

<script src="/js/script.js?v=1.1.0" ></script>
<script>
    var img_resize = 'default';
    function initArticle() {
        /*æ¸²æŸ“å¯¹åº”çš„è¡¨æ ¼æ ·å¼*/
        
            $("#post .pjax table").addClass("green_title");
        

        /*æ¸²æŸ“æ‰“èµæ ·å¼*/
        
        $("input[name=pay]").on("click", function () {
            if($("input[name=pay]:checked").val()=="weixin"){
                $(".shang_box .shang_payimg .pay_img").addClass("weixin_img");
            } else {
                $(".shang_box .shang_payimg .pay_img").removeClass("weixin_img");
            }
        })
        

        /*é«˜äº®ä»£ç å—è¡Œå·*/
        

        /*è®¿é—®æ•°é‡*/
        
        $.getScript("//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js");
        

        /*ä»£ç é«˜äº®ï¼Œè¡Œå·å¯¹é½*/
        $('.pre-numbering').css('line-height',$('.has-numbering').css('line-height'));

        
        
    }

    /*æ‰“èµé¡µé¢éšè—ä¸å±•ç¤º*/
    
    function dashangToggle() {
        $(".shang_box").fadeToggle();
        $(".hide_box").fadeToggle();
    }
    

</script>

<!--åŠ å…¥è¡Œå·çš„é«˜äº®ä»£ç å—æ ·å¼-->

<!--è‡ªå®šä¹‰æ ·å¼è®¾ç½®-->
<style>
    
    
    .nav {
        width: 542px;
    }
    .nav.fullscreen {
        margin-left: -542px;
    }
    .nav-left {
        width: 120px;
    }
    
    
    @media screen and (max-width: 1468px) {
        .nav {
            width: 492px;
        }
        .nav.fullscreen {
            margin-left: -492px;
        }
        .nav-left {
            width: 100px;
        }
    }
    
    
    @media screen and (max-width: 1024px) {
        .nav {
            width: 492px;
            margin-left: -492px
        }
        .nav.fullscreen {
            margin-left: 0;
        }
    }
    
    @media screen and (max-width: 426px) {
        .nav {
            width: 100%;
        }
        .nav-left {
            width: 100%;
        }
    }
    
    
    .nav-right .title-list nav a .post-title, .nav-right .title-list #local-search-result a .post-title {
        color: #383636;
    }
    
    
    .nav-right .title-list nav a .post-date, .nav-right .title-list #local-search-result a .post-date {
        color: #5e5e5f;
    }
    
    
    .nav-right nav a.hover, #local-search-result a.hover{
        background-color: #e2e0e0;
    }
    
    

    /*åˆ—è¡¨æ ·å¼*/
    

    /* èƒŒæ™¯å›¾æ ·å¼ */
    
    


    /*å¼•ç”¨å—æ ·å¼*/
    

    /*æ–‡ç« åˆ—è¡¨èƒŒæ™¯å›¾*/
    

    
</style>







</html>
